<div class="systems-container" [class.dark-mode]="isDarkMode">
  <div class="header-section">
    <h1>Systems</h1>
    <div class="header-buttons">
      <button type="button" class="new-button" (click)="openNewSystemModal()">
        New
      </button>
      <button 
        *ngIf="isMassEditMode && hasSelectedSystems()" 
        type="button" 
        class="mass-edit-button" 
        (click)="startMassEdit()">
        Mass Edit ({{selectedSystems.size}})
      </button>
      <button type="button" class="filter-button" (click)="openFilterModal()">
        Filter
      </button>
    </div>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-message">
      <p>Loading systems...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="error-message">
      <p>{{errorMessage}}</p>
    </div>

    <!-- Systems List -->
    <div *ngIf="!isLoading && !errorMessage" class="systems-list">
      <!-- Filter Status -->
      <div *ngIf="filterService.hasActiveFilters('system')" class="filter-status">
        <div class="filter-info">
          <span class="filter-label">Filtered by:</span>
          <span class="filter-value">{{getActiveFilterDisplayText()}}</span>
          <button type="button" class="clear-filter-button" (click)="clearFilters()">
            Clear Filter
          </button>
        </div>
      </div>

      <div *ngIf="systems.length === 0 && !filterService.hasActiveFilters('system')" class="empty-state">
        <p>No Systems data found.<br><br>To start create a <button type="button" class="link-button" (click)="openNewSystemModal()">New</button> system or go to the <button type="button" class="link-button" (click)="navigateToOptions()">Options</button> page and use the buttons at the bottom to import data.</p>
      </div>

      <div *ngIf="systems.length === 0 && filterService.hasActiveFilters('system')" class="no-systems-message">
        <p>No systems found.</p>
      </div>
      
      <div *ngIf="systems.length > 0" class="table-container">
        <div class="table-header">
          <span class="item-count">{{systemsCount}} {{systemsCount === 1 ? 'System' : 'Systems'}}</span>
        </div>
        <div class="table-wrapper">
          <table class="systems-table">
          <thead>
            <tr>
              <th *ngIf="isMassEditMode" class="edit-column-header">
                <input 
                  type="checkbox" 
                  [checked]="isAllSystemsSelected()"
                  [indeterminate]="isSomeSystemsSelected()"
                  (change)="toggleAllSystems()"
                  class="edit-checkbox select-all-checkbox">
              </th>
              <th>Name</th>
              <th>Generation</th>
              <th>Handheld</th>
              <th *ngFor="let fieldName of customFieldNames" class="custom-field-header">{{fieldName}}</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let system of systems" class="table-row">
              <td *ngIf="isMassEditMode" class="edit-checkbox-cell" (click)="$event.stopPropagation()">
                <input 
                  type="checkbox" 
                  [checked]="isSystemSelected(system.id)"
                  (click)="toggleSystemSelection(system.id, $event)"
                  class="edit-checkbox">
              </td>
              <td class="system-name" (click)="openUpdateSystemModal(system)">
                {{system.name}}
              </td>
              <td class="system-generation" (click)="openUpdateSystemModal(system)">
                {{system.generation}}
              </td>
              <td class="system-handheld" (click)="openUpdateSystemModal(system)">
                <app-boolean-display [value]="system.handheld" size="small"></app-boolean-display>
              </td>
              <td *ngFor="let fieldName of customFieldNames" class="custom-field-value" (click)="openUpdateSystemModal(system)">
                <app-boolean-display 
                  *ngIf="shouldDisplayBooleanBadge(system, fieldName)"
                  [value]="getCustomFieldValue(system, fieldName)"
                  size="small">
                </app-boolean-display>
                <span *ngIf="shouldDisplayCustomField(system, fieldName)">
                  {{getCustomFieldValue(system, fieldName)}}
                </span>
              </td>
              <td class="field-actions">
                <button 
                  type="button" 
                  class="delete-button" 
                  (click)="confirmDeleteSystem(system)"
                  title="Delete system">
                  <span class="delete-text-icon">×</span>
                </button>
              </td>
            </tr>
          </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- New System Modal -->
  <div *ngIf="showNewSystemModal" class="modal-overlay" (click)="closeNewSystemModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{isUpdateMode ? (isMassEditing ? 'Edit System (' + getMassEditProgress().current + ' of ' + getMassEditProgress().total + ')' : 'Edit System') : 'New System'}}</h2>
        <button type="button" class="close-button" (click)="closeNewSystemModal()">×</button>
      </div>
      
      <form (ngSubmit)="onSubmitNewSystem()" #systemForm="ngForm" class="modal-form">
        <div class="form-group">
          <label for="name">Name *</label>
          <app-selectable-text-input
            #nameField
            id="name"
            name="name"
            [(ngModel)]="newSystem.name"
            #nameNgModel="ngModel"
            [required]="true"
            [minlength]="1"
            placeholder="">
          </app-selectable-text-input>
          <div *ngIf="nameNgModel.invalid && nameNgModel.touched" class="error-text">
            Name is required
          </div>
        </div>

        <div class="form-group">
          <label for="generation">Generation *</label>
          <app-selectable-number-input
            id="generation"
            name="generation"
            [(ngModel)]="newSystem.generation"
            #generationField="ngModel"
            required
            [min]="1"
            [step]="1"
            class="form-input"
            placeholder="">
          </app-selectable-number-input>
          <div *ngIf="generationField.invalid && generationField.touched" class="error-text">
            Generation is required and must be a positive number
          </div>
        </div>

        <div class="form-group">
          <app-custom-checkbox
            id="handheld"
            name="handheld"
            label="Handheld"
            [(ngModel)]="newSystem.handheld">
          </app-custom-checkbox>
        </div>

        <!-- Dynamic Custom Fields -->
        <app-dynamic-custom-fields 
          entityKey="system" 
          [(customFieldValues)]="newSystem.customFieldValues">
        </app-dynamic-custom-fields>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="closeNewSystemModal()">
            Cancel
          </button>
          <button 
            *ngIf="isUpdateMode || !isMassInputMode"
            type="submit" 
            class="create-button" 
            [disabled]="!systemForm.form.valid || isCreating">
            {{isCreating ? (isUpdateMode ? 'Editing...' : 'Creating...') : (isUpdateMode ? 'Edit' : 'Create')}}
          </button>
          <button 
            *ngIf="!isUpdateMode && isMassInputMode"
            type="button" 
            class="create-and-add-button" 
            [disabled]="!systemForm.form.valid || isCreating"
            (click)="onSubmitAndAddAnother()">
            {{isCreating ? 'Creating...' : 'Create and Add Another'}}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteConfirmModal" class="modal-overlay" (click)="closeDeleteConfirmModal()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button type="button" class="close-button" (click)="closeDeleteConfirmModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p>Are you sure you want to delete the system <strong>"{{systemToDelete?.name}}"</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-button" (click)="closeDeleteConfirmModal()">
          Cancel
        </button>
        <button type="button" class="delete-confirm-button" (click)="deleteSystem()" [disabled]="isDeleting">
          {{isDeleting ? 'Deleting...' : 'Delete'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Entity Filter Modal -->
  <app-entity-filter-modal
    entityType="system"
    [(show)]="showFilterModal"
    (filtersApplied)="onFiltersApplied($event)">
  </app-entity-filter-modal>
</div>
