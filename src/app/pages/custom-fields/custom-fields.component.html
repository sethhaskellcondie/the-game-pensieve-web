<div class="custom-fields-container" [class.dark-mode]="isDarkMode">
  <div class="header-section">
    <h1>Custom Fields</h1>
    <div class="header-buttons">
      <button type="button" class="new-button" (click)="openNewCustomFieldModal()">
        New
      </button>
      <button type="button" class="filter-button" (click)="openFilterModal()">
        Filter
      </button>
    </div>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-message">
      <p>Loading custom fields...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="error-message">
      <p>{{errorMessage}}</p>
    </div>

    <!-- Custom Fields List -->
    <div *ngIf="!isLoading && !errorMessage" class="custom-fields-list">
      <!-- Filter Status -->
      <div *ngIf="currentFilter" class="filter-status">
        <div class="filter-info">
          <span class="filter-label">Filtered by:</span>
          <span class="filter-value">{{getFilterDisplayText()}}</span>
          <button type="button" class="clear-filter-button" (click)="clearFilter()">
            Clear Filter
          </button>
        </div>
      </div>

      <div *ngIf="customFields.length === 0 && !currentFilter" class="empty-state">
        <p>No Custom Fields data found.<br><br>To start create a <button type="button" class="link-button" (click)="openNewCustomFieldModal()">New</button> custom field or go to the <button type="button" class="link-button" (click)="navigateToOptions()">Options</button> page and use the buttons at the bottom to import data.</p>
      </div>

      <div *ngIf="customFields.length === 0 && currentFilter" class="no-fields-message">
        <p>No custom fields found.</p>
      </div>
      
      <div *ngIf="customFields.length > 0" class="table-container">
        <div class="table-header">
          <span class="item-count">{{customFieldsCount}} {{customFieldsCount === 1 ? 'Custom Field' : 'Custom Fields'}}</span>
        </div>
        <table class="custom-fields-table">
          <thead>
            <tr>
              <th class="sortable-header" (click)="sortTable('name')">
                Name <span class="sort-icon">{{getSortIcon('name')}}</span>
              </th>
              <th class="sortable-header" (click)="sortTable('type')">
                Custom Field Type <span class="sort-icon">{{getSortIcon('type')}}</span>
              </th>
              <th class="sortable-header" (click)="sortTable('entity')">
                Type <span class="sort-icon">{{getSortIcon('entity')}}</span>
              </th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let field of sortedCustomFields" class="table-row">
              <td class="field-name" (click)="startEditingField(field)">
                <div *ngIf="editingFieldId !== field.id" class="field-name-display">
                  {{field.name}}
                </div>
                <div *ngIf="editingFieldId === field.id" class="field-name-edit">
                  <input 
                    type="text" 
                    [(ngModel)]="editingFieldName"
                    (keyup.enter)="saveFieldName(field)"
                    (keyup.escape)="cancelEditing()"
                    (blur)="saveFieldName(field)"
                    class="edit-input"
                    #nameInput>
                </div>
              </td>
              <td class="field-type" (click)="startEditingField(field)">
                <span class="type-badge" [class]="'type-' + field.type">{{getTypeDisplayName(field.type)}}</span>
              </td>
              <td class="field-entity" (click)="startEditingField(field)">
                <span class="entity-badge" [style.background-color]="getEntityColor(field.entityKey) + '20'" [style.color]="getEntityColor(field.entityKey)">{{getEntityDisplayName(field.entityKey)}}</span>
              </td>
              <td class="field-actions">
                <button 
                  type="button" 
                  class="delete-button" 
                  (click)="confirmDeleteCustomField(field)"
                  title="Delete custom field">
                  <span class="delete-text-icon">×</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- New Custom Field Modal -->
  <div *ngIf="showNewCustomFieldModal" class="modal-overlay" (click)="closeNewCustomFieldModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>New Custom Field</h2>
        <button type="button" class="close-button" (click)="closeNewCustomFieldModal()">×</button>
      </div>
      
      <form (ngSubmit)="onSubmitNewCustomField()" #customFieldForm="ngForm" class="modal-form">
        <div class="form-group">
          <label for="name">Name *</label>
          <app-selectable-text-input
            id="name" 
            name="name" 
            [(ngModel)]="newCustomField.name"
            #nameField="ngModel"
            #nameInputComponent
            [required]="true"
            [minlength]="1"
            placeholder="">
          </app-selectable-text-input>
          <div *ngIf="nameField.invalid && nameField.touched" class="error-text">
            Name is required
          </div>
        </div>

        <div class="form-group">
          <label for="type">Custom Field Type *</label>
          <app-filterable-dropdown
            id="type"
            name="type"
            [(ngModel)]="newCustomField.type"
            #typeField="ngModel"
            [options]="typeOptions"
            placeholder=""
            [required]="true">
          </app-filterable-dropdown>
          <div *ngIf="typeField.invalid && typeField.touched" class="error-text">
            Type is required
          </div>
        </div>

        <div class="form-group">
          <label for="entityKey">Type *</label>
          <app-filterable-dropdown
            id="entityKey"
            name="entityKey"
            [(ngModel)]="newCustomField.entityKey"
            #entityKeyField="ngModel"
            [options]="entityOptions"
            placeholder=""
            [required]="true">
          </app-filterable-dropdown>
          <div *ngIf="entityKeyField.invalid && entityKeyField.touched" class="error-text">
            Entity type is required
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="closeNewCustomFieldModal()">
            Cancel
          </button>
          <button 
            *ngIf="!isMassInputMode"
            type="submit" 
            class="create-button" 
            [disabled]="!customFieldForm.form.valid || isCreating">
            {{isCreating ? 'Creating...' : 'Create'}}
          </button>
          <button 
            *ngIf="isMassInputMode"
            type="button" 
            class="create-and-add-button" 
            [disabled]="!customFieldForm.form.valid || isCreating"
            (click)="onSubmitAndAddAnother()">
            {{isCreating ? 'Creating...' : 'Create and Add Another'}}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteConfirmModal" class="modal-overlay" (click)="closeDeleteConfirmModal()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button type="button" class="close-button" (click)="closeDeleteConfirmModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p>Are you sure you want to delete the custom field <strong>"{{fieldToDelete?.name}}"</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-button" (click)="closeDeleteConfirmModal()">
          Cancel
        </button>
        <button type="button" class="delete-confirm-button" (click)="deleteCustomField()" [disabled]="isDeleting">
          {{isDeleting ? 'Deleting...' : 'Delete'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Modal -->
  <div *ngIf="showFilterModal" class="modal-overlay" (click)="closeFilterModal()">
    <div class="modal-content filter-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Filter Custom Fields</h2>
        <button type="button" class="close-button" (click)="closeFilterModal()">×</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="filterEntity">Entity *</label>
          <app-filterable-dropdown
            id="filterEntity"
            name="filterEntity"
            [(ngModel)]="filterEntityKey"
            [options]="entityOptions"
            placeholder=""
            [required]="true">
          </app-filterable-dropdown>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-button" (click)="closeFilterModal()">
          Cancel
        </button>
        <button type="button" class="filter-apply-button" (click)="applyFilter()" [disabled]="!filterEntityKey || isFiltering">
          {{isFiltering ? 'Filtering...' : 'Apply Filter'}}
        </button>
      </div>
    </div>
  </div>
</div>
