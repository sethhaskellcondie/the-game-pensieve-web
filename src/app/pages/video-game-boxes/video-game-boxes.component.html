<div class="video-game-boxes-container" [class.dark-mode]="isDarkMode">
  <div class="header-section">
    <h1>Video Games (Shelf View)</h1>
    <div class="header-buttons">
      <button type="button" class="new-button" (click)="openNewVideoGameBoxModal()">
        New
      </button>
      <button 
        *ngIf="isMassEditMode && hasSelectedVideoGameBoxes()" 
        type="button" 
        class="mass-edit-button" 
        (click)="startMassEdit()">
        Mass Edit ({{selectedVideoGameBoxes.size}})
      </button>
      <button type="button" class="filter-button" (click)="openFilterModal()">
        Filter
      </button>
    </div>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-message">
      <p>Loading video game boxes...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="error-message">
      <p>{{errorMessage}}</p>
    </div>

    <!-- Video Game Boxes List -->
    <div *ngIf="!isLoading && !errorMessage" class="video-game-boxes-list">
      <!-- Filter Status -->
      <div *ngIf="filterService.hasActiveFilters('videoGameBox')" class="filter-status">
        <div class="filter-info">
          <span class="filter-label">Filtered by:</span>
          <span class="filter-value">{{getActiveFilterDisplayText()}}</span>
          <button type="button" class="clear-filter-button" (click)="clearFilters()">
            Clear Filter
          </button>
        </div>
      </div>
      
      <div *ngIf="videoGameBoxes.length === 0 && !filterService.hasActiveFilters('videoGameBox')" class="empty-state">
        <p>No Video Game Boxes data found.<br><br>
            Video Game Boxes represent how video games appear on your shelf, each video game box must include what Video Games are included in that box. Some Boxes are collections, or re-releases of other Video Games, this is setup in the Video Game Box. <br><br>
            To start create a <button type="button" class="link-button" (click)="openNewVideoGameBoxModal()">New</button> video game box or go to the <button type="button" class="link-button" (click)="navigateToOptions()">Options</button> page and use the buttons at the bottom to import data.</p>
      </div>

      <div *ngIf="videoGameBoxes.length === 0 && filterService.hasActiveFilters('videoGameBox')" class="no-games-message">
        <p>No video game boxes found.</p>
      </div>
      
      <div *ngIf="videoGameBoxes.length > 0" class="table-container">
        <div class="table-header">
          <span class="item-count">{{videoGameBoxesCount}} {{videoGameBoxesCount === 1 ? 'Video Game Box' : 'Video Game Boxes'}}</span>
        </div>
        <table class="video-game-boxes-table">
          <thead>
            <tr>
              <th *ngIf="isMassEditMode" class="edit-column-header">
                <input 
                  type="checkbox" 
                  [checked]="isAllVideoGameBoxesSelected()"
                  [indeterminate]="isSomeVideoGameBoxesSelected()"
                  (change)="toggleAllVideoGameBoxes()"
                  class="edit-checkbox select-all-checkbox">
              </th>
              <th>Title</th>
              <th>System</th>
              <th>Physical</th>
              <th>Collection</th>
              <th *ngFor="let fieldName of customFieldNames" class="custom-field-header">{{fieldName}}</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let box of videoGameBoxes" class="table-row">
              <td *ngIf="isMassEditMode" class="edit-checkbox-cell" (click)="$event.stopPropagation()">
                <input 
                  type="checkbox" 
                  [checked]="isVideoGameBoxSelected(box.id)"
                  (click)="toggleVideoGameBoxSelection(box.id, $event)"
                  class="edit-checkbox">
              </td>
              <td class="game-title" (click)="navigateToDetail(box.id)">{{box.title}}</td>
              <td class="game-system" (click)="navigateToDetail(box.id)">{{box.system.name}}</td>
              <td class="game-physical" (click)="navigateToDetail(box.id)">
                <app-boolean-display [value]="box.isPhysical" size="small"></app-boolean-display>
              </td>
              <td class="game-collection" (click)="navigateToDetail(box.id)">
                <app-boolean-display [value]="box.isCollection" size="small"></app-boolean-display>
              </td>
              <td *ngFor="let fieldName of customFieldNames" class="custom-field-value" (click)="navigateToDetail(box.id)">
                <app-boolean-display 
                  *ngIf="shouldDisplayBooleanBadge(box, fieldName)"
                  [value]="getCustomFieldValue(box, fieldName)"
                  size="small">
                </app-boolean-display>
                <span *ngIf="shouldDisplayCustomField(box, fieldName)">
                  {{getCustomFieldValue(box, fieldName)}}
                </span>
              </td>
              <td class="field-actions">
                <button 
                  type="button" 
                  class="delete-button" 
                  (click)="confirmDeleteVideoGameBox(box); $event.stopPropagation()"
                  title="Delete video game box">
                  <span class="delete-text-icon">×</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Detail Video Game Box Modal -->
  <div *ngIf="showDetailVideoGameBoxModal" class="modal-overlay" (click)="closeDetailVideoGameBoxModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{selectedVideoGameBox?.title}} Details</h2>
        <div class="modal-header-actions">
          <button type="button" class="edit-button" (click)="openEditFromDetail()">
            Edit
          </button>
          <button type="button" class="close-button" (click)="closeDetailVideoGameBoxModal()">×</button>
        </div>
      </div>
      
      <div class="modal-body" *ngIf="selectedVideoGameBox">
        <!-- System Information -->
        <div class="system-inline">
          <span class="system-label">System:</span>
          <span class="system-name">{{selectedVideoGameBox.system.name}} (Gen {{selectedVideoGameBox.system.generation}})</span>
        </div>

        <!-- Box Properties -->
        <div class="box-properties-inline">
          <div class="property-badges">
            <span class="badge" [class]="selectedVideoGameBox.isPhysical ? 'badge-physical' : 'badge-digital'">
              {{selectedVideoGameBox.isPhysical ? 'Physical' : 'Digital'}}
            </span>
            <span class="badge" [class]="selectedVideoGameBox.isCollection ? 'badge-collection' : 'badge-single'">
              {{selectedVideoGameBox.isCollection ? 'Collection' : 'Single Game'}}
            </span>
          </div>
        </div>

        <!-- Custom Fields -->
        <div class="custom-fields-inline" *ngIf="selectedVideoGameBox.customFieldValues.length > 0">
          <div class="detail-grid">
            <div class="detail-item" *ngFor="let field of selectedVideoGameBox.customFieldValues">
              <label>{{field.customFieldName}}:</label>
              <app-boolean-display 
                *ngIf="field.customFieldType === 'boolean'; else textValue"
                [value]="field.value"
                size="small">
              </app-boolean-display>
              <ng-template #textValue>
                <span>{{field.value}}</span>
              </ng-template>
            </div>
          </div>
        </div>

        <!-- Video Games -->
        <div class="detail-section">
          <h3>{{selectedVideoGameBox.isCollection ? 'Games in Collection' : 'Games in Box'}}</h3>
          <div *ngIf="selectedVideoGameBox.videoGames.length === 0" class="no-data-message">
            This video game box contains no games.
          </div>
          <div *ngIf="selectedVideoGameBox.videoGames.length > 0" class="games-list">
            <div class="game-item" *ngFor="let game of selectedVideoGameBox.videoGames">
              <div class="game-header">
                <h4>{{game.title}}</h4>
              </div>
              <div class="game-details">
                <p><strong>System:</strong> {{game.system.name}}</p>
                <div *ngIf="game.customFieldValues.length > 0" class="game-custom-fields">
                  <div class="custom-field" *ngFor="let field of game.customFieldValues">
                    <strong>{{field.customFieldName}}:</strong> 
                    <app-boolean-display 
                      *ngIf="field.customFieldType === 'boolean'; else textValue"
                      [value]="field.value"
                      size="small">
                    </app-boolean-display>
                    <ng-template #textValue>
                      {{field.value}}
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Video Game Box Modal -->
  <div *ngIf="showNewVideoGameBoxModal" class="modal-overlay" (click)="closeNewVideoGameBoxModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{isUpdateMode ? (isMassEditing ? 'Update Video Game Box (' + getMassEditProgress().current + ' of ' + getMassEditProgress().total + ')' : 'Update Video Game Box') : 'New Video Game Box'}}</h2>
        <div class="modal-header-actions">
          <button *ngIf="isUpdateMode" type="button" class="details-button" (click)="openDetailFromEdit()">
            Details
          </button>
          <button type="button" class="close-button" (click)="closeNewVideoGameBoxModal()">×</button>
        </div>
      </div>
      
      <form (ngSubmit)="onSubmitNewVideoGameBox()" #videoGameBoxForm="ngForm" class="modal-form">
        <div class="form-group">
          <label for="title">Title *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            [(ngModel)]="newVideoGameBox.title"
            #titleField="ngModel"
            required
            minlength="1"
            class="form-input"
            placeholder="">
          <div *ngIf="titleField.invalid && titleField.touched" class="error-text">
            Title is required
          </div>
        </div>

        <div class="form-group">
          <label for="systemId">System *</label>
          <app-filterable-dropdown
            id="systemId"
            name="systemId"
            [(ngModel)]="newVideoGameBox.systemId"
            [options]="systemOptions"
            [required]="true"
            placeholder="">
          </app-filterable-dropdown>
        </div>

        <div class="form-group">
          <app-custom-checkbox
            id="isPhysical"
            name="isPhysical"
            label="Physical"
            [(ngModel)]="newVideoGameBox.isPhysical">
          </app-custom-checkbox>
        </div>

        <div class="form-group">
          <app-custom-checkbox
            id="isCollection"
            name="isCollection"
            label="Collection"
            [(ngModel)]="newVideoGameBox.isCollection">
          </app-custom-checkbox>
        </div>

        <!-- Dynamic Custom Fields -->
        <app-dynamic-custom-fields 
          entityKey="videoGameBox" 
          [customFieldValues]="newVideoGameBox.customFieldValues"
          (customFieldValuesChange)="onCustomFieldValuesChange($event)">
        </app-dynamic-custom-fields>

        <!-- Video Games Section -->
        <div class="form-group video-games-section">
          <label>Video Games</label>
          <div class="new-games-list" *ngIf="newVideoGameBox.videoGames.length > 0">
            <div class="new-game-item" *ngFor="let videoGame of newVideoGameBox.videoGames; let i = index">
              
              <!-- Collapsed View - Show when video game is selected and not being edited -->
              <div class="game-collapsed" *ngIf="isVideoGameSelected(videoGame) && !isVideoGameBeingEdited(i)" (click)="editVideoGame(i)">
                <div class="collapsed-content">
                  <span class="game-title">{{getVideoGameDisplayText(videoGame)}}</span>
                  <span class="game-type-badge" [class]="videoGame.type === 'existing' ? 'badge-existing' : 'badge-new'">
                    {{getVideoGameTypeLabel(videoGame)}}
                  </span>
                </div>
                <button type="button" class="remove-button" (click)="removeVideoGame(i); $event.stopPropagation()">×</button>
              </div>

              <!-- Expanded View - Show when video game is not selected OR being edited -->
              <div class="game-expanded" *ngIf="!isVideoGameSelected(videoGame) || isVideoGameBeingEdited(i)">
                <div class="game-header">
                  <div class="video-game-type-selection">
                    <label class="radio-label">
                      <input 
                        type="radio" 
                        [name]="'videoGameType' + i" 
                        value="existing"
                        [(ngModel)]="videoGame.type"
                        class="radio-input">
                      <span class="radio-text">Select Existing</span>
                    </label>
                    <label class="radio-label">
                      <input 
                        type="radio" 
                        [name]="'videoGameType' + i" 
                        value="new"
                        [(ngModel)]="videoGame.type"
                        class="radio-input">
                      <span class="radio-text">Create New</span>
                    </label>
                  </div>
                  
                  <!-- Show save/cancel buttons when editing, otherwise show remove button -->
                  <div class="game-actions" *ngIf="isVideoGameBeingEdited(i)">
                    <button type="button" class="save-button" (click)="saveVideoGameEdit(i)">✓</button>
                    <button type="button" class="cancel-button" (click)="cancelVideoGameEdit(i)">×</button>
                  </div>
                  <button type="button" class="remove-button" *ngIf="!isVideoGameBeingEdited(i)" (click)="removeVideoGame(i)">×</button>
                </div>
                
                <!-- Existing Video Game Selection -->
                <div class="form-group" *ngIf="videoGame.type === 'existing'">
                  <label for="existingGame{{i}}">Select Video Game *</label>
                  <app-filterable-dropdown
                    id="existingGame{{i}}"
                    [name]="'existingVideoGameId' + i"
                    [(ngModel)]="videoGame.existingVideoGameId"
                    [options]="videoGameOptions"
                    [required]="true"
                    placeholder="Select a video game">
                  </app-filterable-dropdown>
                </div>

                <!-- New Video Game Creation -->
                <div *ngIf="videoGame.type === 'new'">
                  <div class="form-group">
                    <label for="newGameTitle{{i}}">Title *</label>
                    <input 
                      type="text"
                      id="newGameTitle{{i}}"
                      [(ngModel)]="videoGame.title"
                      [name]="'newGameTitle' + i"
                      class="form-input"
                      placeholder="">
                  </div>
                  <div class="form-group">
                    <label for="newGameSystem{{i}}">System *</label>
                    <app-filterable-dropdown
                      id="newGameSystem{{i}}"
                      [name]="'newGameSystemId' + i"
                      [(ngModel)]="videoGame.systemId"
                      [options]="systemOptions"
                      [required]="true"
                      placeholder="">
                    </app-filterable-dropdown>
                  </div>
                  <app-dynamic-custom-fields 
                    entityKey="videoGame" 
                    [(customFieldValues)]="videoGame.customFieldValues">
                  </app-dynamic-custom-fields>
                </div>
              </div>
            </div>
          </div>
          <button type="button" class="add-game-button" (click)="addNewVideoGame()">
            + Add Video Game
          </button>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="closeNewVideoGameBoxModal()">
            Cancel
          </button>
          <button 
            *ngIf="isUpdateMode || !isMassInputMode"
            type="submit" 
            class="create-button" 
            [disabled]="!isFormCompletelyValid(videoGameBoxForm) || isCreating">
            {{isCreating ? (isUpdateMode ? 'Updating...' : 'Creating...') : (isUpdateMode ? 'Update' : 'Create')}}
          </button>
          <button 
            *ngIf="!isUpdateMode && isMassInputMode"
            type="button" 
            class="create-and-add-button" 
            [disabled]="!isFormCompletelyValid(videoGameBoxForm) || isCreating"
            (click)="onSubmitAndAddAnother()">
            {{isCreating ? 'Creating...' : 'Create and Add Another'}}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteConfirmModal" class="modal-overlay" (click)="closeDeleteConfirmModal()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button type="button" class="close-button" (click)="closeDeleteConfirmModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p>Are you sure you want to delete the video game box <strong>"{{videoGameBoxToDelete?.title}}"</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-button" (click)="closeDeleteConfirmModal()">
          Cancel
        </button>
        <button type="button" class="delete-confirm-button" (click)="deleteVideoGameBox()" [disabled]="isDeleting">
          {{isDeleting ? 'Deleting...' : 'Delete'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Entity Filter Modal -->
  <app-entity-filter-modal
    entityType="videoGameBox"
    [(show)]="showFilterModal"
    (filtersApplied)="onFiltersApplied($event)">
  </app-entity-filter-modal>
</div>